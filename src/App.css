import React, { useState, useRef, useEffect } from 'react';
import { 
  Plus, Music, Headphones, Eye, Settings, Upload, 
  Trash2, Layout, Zap, ChevronRight, Layers, Maximize2 
} from 'lucide-react';
import { useProximityAudio } from './useProximityAudio';

export default function App() {
  const [panels, setPanels] = useState([{ id: 'p1', imageUrl: null, triggers: [] }]);
  const [activeTab, setActiveTab] = useState('editor');
  const [hoveredPanel, setHoveredPanel] = useState(null);
  const { register, unregister } = useProximityAudio(500);
  const panelRefs = useRef({});

  useEffect(() => {
    if (activeTab === 'preview') {
      panels.forEach(p => p.triggers.forEach(t => {
        if (t.audioUrl) register({ 
          id: t.id, 
          src: t.audioUrl, 
          panelEl: panelRefs.current[p.id], 
          yPos: t.yPos, 
          maxVolume: t.volume || 0.8 
        });
      }));
    } else {
      panels.forEach(p => p.triggers.forEach(t => unregister(t.id)));
    }
  }, [activeTab, panels]);

  const addPanel = () => setPanels([...panels, { id: `p-${Date.now()}`, imageUrl: null, triggers: [] }]);
  
  const deletePanel = (id) => setPanels(panels.filter(p => p.id !== id));

  return (
    <div style={{ 
      backgroundColor: '#050505', 
      color: '#fff', 
      height: '100vh', 
      display: 'flex', 
      fontFamily: '"Inter", sans-serif',
      letterSpacing: '-0.02em'
    }}>
      
      {/* Sidebar Navigation */}
      <aside style={{ 
        width: '320px', 
        background: '#080808', 
        borderRight: '1px solid #151515', 
        display: 'flex', 
        flexDirection: 'column', 
        padding: '32px' 
      }}>
        <div style={{ 
          display: 'flex', 
          alignItems: 'center', 
          gap: '14px', 
          color: '#3b82f6', 
          fontSize: '22px', 
          fontWeight: '900', 
          marginBottom: '48px' 
        }}>
          <div style={{ 
            padding: '10px', 
            background: 'linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0) 100%)', 
            borderRadius: '16px',
            border: '1px solid rgba(59,130,246,0.2)'
          }}><Zap size={26} fill="#3b82f6" /></div>
          SOUNDTUNE <span style={{ color: '#555', fontSize: '12px', fontWeight: '400' }}>v2.0</span>
        </div>

        <div style={{ marginBottom: '32px' }}>
          <p style={{ color: '#444', fontSize: '11px', fontWeight: '800', textTransform: 'uppercase', marginBottom: '16px', letterSpacing: '1px' }}>Project Assets</p>
          <button onClick={addPanel} style={{ 
            width: '100%', 
            padding: '18px', 
            background: '#3b82f6', 
            border: 'none', 
            borderRadius: '20px', 
            color: '#fff', 
            fontWeight: '800', 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            gap: '10px', 
            cursor: 'pointer', 
            boxShadow: '0 10px 30px rgba(59,130,246,0.25)',
            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
          }} onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-2px)'}
             onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
            <Plus size={22} strokeWidth={3} /> New Page
          </button>
        </div>

        <div style={{ flex: 1, overflowY: 'auto' }}>
          {panels.map((p, i) => (
            <div key={p.id} style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: '12px', 
              padding: '12px', 
              background: '#111', 
              borderRadius: '14px', 
              marginBottom: '10px',
              border: '1px solid #1a1a1a'
            }}>
              <div style={{ fontSize: '10px', color: '#444', fontWeight: 'bold' }}>0{i+1}</div>
              <div style={{ flex: 1, fontSize: '12px', color: '#aaa', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                {p.imageUrl ? 'Image Loaded' : 'Empty Canvas'}
              </div>
              {p.triggers.length > 0 && <Music size={12} color="#3b82f6" />}
            </div>
          ))}
        </div>

        <div style={{ 
          marginTop: 'auto', 
          padding: '24px', 
          background: 'linear-gradient(180deg, #0a0a0a 0%, #050505 100%)', 
          borderRadius: '24px', 
          border: '1px solid #151515' 
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '10px', fontSize: '13px', color: '#fff', fontWeight: '700', marginBottom: '8px' }}>
            <Layers size={16} color="#3b82f6" /> Smart Engine
          </div>
          <p style={{ fontSize: '11px', color: '#555', lineHeight: '1.6', margin: 0 }}>
            Audio proximity is set to <span style={{ color: '#3b82f6' }}>500px</span>. Sound fades in as user scrolls to content.
          </p>
        </div>
      </aside>

      {/* Main Content Area */}
      <main style={{ 
        flex: 1, 
        overflowY: 'auto', 
        position: 'relative', 
        background: '#000',
        scrollBehavior: 'smooth'
      }}>
        
        {/* Floating Header */}
        <div style={{ 
          position: 'sticky', 
          top: '32px', 
          zIndex: 1000, 
          display: 'flex', 
          justifyContent: 'center',
          pointerEvents: 'none'
        }}>
          <div style={{ 
            background: 'rgba(10,10,10,0.7)', 
            backdropFilter: 'blur(30px) saturate(180%)', 
            padding: '8px', 
            borderRadius: '24px', 
            border: '1px solid rgba(255,255,255,0.08)', 
            display: 'flex', 
            gap: '6px',
            pointerEvents: 'auto',
            boxShadow: '0 20px 40px rgba(0,0,0,0.4)'
          }}>
            <button onClick={() => setActiveTab('editor')} style={{ 
              padding: '12px 32px', 
              borderRadius: '18px', 
              border: 'none', 
              fontSize: '11px', 
              fontWeight: '900', 
              letterSpacing: '1px',
              cursor: 'pointer', 
              background: activeTab === 'editor' ? '#fff' : 'transparent', 
              color: activeTab === 'editor' ? '#000' : '#888', 
              transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)' 
            }}>STUDIO</button>
            <button onClick={() => setActiveTab('preview')} style={{ 
              padding: '12px 32px', 
              borderRadius: '18px', 
              border: 'none', 
              fontSize: '11px', 
              fontWeight: '900', 
              letterSpacing: '1px',
              cursor: 'pointer', 
              background: activeTab === 'preview' ? '#3b82f6' : 'transparent', 
              color: activeTab === 'preview' ? '#fff' : '#888', 
              transition: 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)' 
            }}>PREVIEW</button>
          </div>
        </div>

        <div style={{ maxWidth: '800px', margin: '80px auto', padding: '0 40px 200px 40px' }}>
          {panels.map((panel) => (
            <div 
              key={panel.id} 
              ref={el => panelRefs.current[panel.id] = el}
              onMouseEnter={() => setHoveredPanel(panel.id)}
              onMouseLeave={() => setHoveredPanel(null)}
              style={{ 
                marginBottom: '64px', 
                position: 'relative',
                transition: 'transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)'
              }}
            >
              {!panel.imageUrl ? (
                <div style={{ 
                  height: '700px', 
                  width: '100%', 
                  background: '#080808', 
                  border: '2px dashed #151515', 
                  borderRadius: '48px', 
                  display: 'flex', 
                  flexDirection: 'column', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  transition: 'all 0.4s', 
                  position: 'relative',
                  overflow: 'hidden'
                }}>
                  <input type="file" style={{ position: 'absolute', inset: 0, opacity: 0, cursor: 'pointer', zIndex: 10 }} 
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) setPanels(prev => prev.map(p => p.id === panel.id ? {...p, imageUrl: URL.createObjectURL(file)} : p));
                    }} 
                  />
                  <div style={{ 
                    width: '80px', 
                    height: '80px', 
                    background: 'rgba(59,130,246,0.05)', 
                    color: '#3b82f6', 
                    borderRadius: '28px', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    marginBottom: '24px',
                    border: '1px solid rgba(59,130,246,0.1)'
                  }}>
                    <Upload size={32} strokeWidth={2.5} />
                  </div>
                  <div style={{ fontWeight: '800', fontSize: '16px', color: '#fff' }}>New Page Canvas</div>
                  <div style={{ fontSize: '12px', color: '#444', marginTop: '8px' }}>Upload your manhwa vertical strip</div>
                </div>
              ) : (
                <div style={{ 
                  position: 'relative', 
                  borderRadius: '48px', 
                  overflow: 'hidden', 
                  boxShadow: '0 50px 100px -20px rgba(0,0,0,0.7)', 
                  border: '1px solid rgba(255,255,255,0.05)',
                  cursor: activeTab === 'editor' ? 'crosshair' : 'default' 
                }} onClick={(e) => {
                  if (activeTab === 'preview') return;
                  const rect = e.currentTarget.getBoundingClientRect();
                  const yPos = (e.clientY - rect.top) / rect.height;
                  setPanels(prev => prev.map(p => p.id === panel.id ? { 
                    ...p, 
                    triggers: [...p.triggers, { id: `t-${Date.now()}`, yPos, audioUrl: null, volume: 0.8 }] 
                  } : p));
                }}>
                  <img src={panel.imageUrl} style={{ width: '100%', display: 'block', transition: 'all 0.5s' }} />
                  
                  {activeTab === 'editor' && panel.triggers.map(t => (
                    <div key={t.id} style={{ 
                      position: 'absolute', 
                      left: '50%', 
                      top: `${t.yPos * 100}%`, 
                      transform: 'translate(-50%, -50%)', 
                      zIndex: 10,
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      <div className="audio-pulse" style={{ 
                        background: t.audioUrl ? '#3b82f6' : '#f43f5e', 
                        padding: '16px', 
                        borderRadius: '50%', 
                        border: '4px solid #fff', 
                        boxShadow: '0 0 30px rgba(59,130,246,0.4)', 
                        position: 'relative',
                        transition: 'all 0.3s'
                      }}>
                        <Music size={20} color="#fff" strokeWidth={3} />
                        <input 
                          type="file" 
                          accept="audio/*" 
                          style={{ position: 'absolute', inset: 0, opacity: 0, cursor: 'pointer' }} 
                          onClick={(e) => e.stopPropagation()} 
                          onChange={(e) => {
                            const file = e.target.files?.[0];
                            if (file) {
                              const url = URL.createObjectURL(file);
                              setPanels(prev => prev.map(p => p.id === panel.id ? { 
                                ...p, 
                                triggers: p.triggers.map(tr => tr.id === t.id ? { ...tr, audioUrl: url } : tr) 
                              } : p));
                            }
                          }} 
                        />
                      </div>
                      <button 
                        onClick={(e) => {
                          e.stopPropagation();
                          setPanels(prev => prev.map(p => p.id === panel.id ? {
                            ...p,
                            triggers: p.triggers.filter(tr => tr.id !== t.id)
                          } : p));
                        }}
                        style={{ 
                          background: 'rgba(244,63,94,0.1)', 
                          border: 'none', 
                          color: '#f43f5e', 
                          padding: '6px 12px', 
                          borderRadius: '8px', 
                          fontSize: '10px', 
                          fontWeight: 'bold',
                          cursor: 'pointer'
                        }}
                      >REMOVE</button>
                    </div>
                  ))}

                  {/* Panel Actions Hover */}
                  {hoveredPanel === panel.id && activeTab === 'editor' && (
                    <div style={{
                      position: 'absolute',
                      top: '20px',
                      right: '20px',
                      display: 'flex',
                      gap: '10px'
                    }}>
                      <button onClick={(e) => { e.stopPropagation(); deletePanel(panel.id); }} style={{
                        background: 'rgba(244,63,94,0.9)',
                        color: '#fff',
                        border: 'none',
                        padding: '10px',
                        borderRadius: '12px',
                        cursor: 'pointer'
                      }}><Trash2 size={18} /></button>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
          
          {activeTab === 'editor' && (
             <div onClick={addPanel} style={{
               padding: '40px',
               textAlign: 'center',
               color: '#222',
               fontSize: '14px',
               fontWeight: '900',
               cursor: 'pointer',
               border: '2px solid #080808',
               borderRadius: '40px'
             }}>
               END OF PROJECT - CLICK TO ADD PAGE
             </div>
          )}
        </div>
      </main>
    </div>
  );
}